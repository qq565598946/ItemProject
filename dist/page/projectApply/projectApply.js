"use strict";var form=layui.form,upload=layui.upload,laypage=layui.laypage;function GetQueryString(e){var a=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),t=window.location.search.substr(1).match(a);return null!=t?unescape(t[2]):null}var accessToken=GetQueryString("TokenCode"),xhsdk=new Xhsdk(appID,appSecretKey);xhsdk.setGetaWayUrl(GetaWay_url),xhsdk.setToken(accessToken),xhsdk.setReqType("app"),xhsdk.setUserInfo(null);var tag=GetQueryString("tag"),deatailId=GetQueryString("deatailId"),status=GetQueryString("status"),loadingtip=$(".loading-box");if(2==tag){$(".itemDes").text("项目立项修改"),$(".right-sp span:eq(1)").text("修改项目");var editHtml=null;0==status?(editHtml='<div class="submitbutton" lay-submit="" lay-filter="sumbitApply" id="submit">提交申请</div>\n                        <div class="savebutton" id="save" onclick="projectinfo()">保存</div>',$(".submit-box").html(editHtml)):3==status&&(editHtml='<div class="submitbutton" lay-submit="" lay-filter="sumbitApply" id="submit">提交申请</div>',$(".submit-box").html(editHtml)),detailsData()}else editHtml='<div class="submitbutton" lay-submit="" lay-filter="sumbitApply" id="submit">提交申请</div>\n                    <div class="savebutton"  id="save" onclick="projectinfo()">保存</div>',$(".submit-box").html(editHtml),InitbuildUnit();function InitbuildUnit(){var e={accessToken:accessToken};xhsdk.ajax({type:"post",url:solution+"/projectinfo/getBuildUnitLeader",contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:function(e){if(200==e.code){e.data;$("#buildUnit").val(e.data.deptName),$("#staffvalue").val(e.data.userName),$("#staffvalue").attr("data-userId",e.data.userId),$("#buildUnit").attr("data-code",e.data.deptCode),sessionStorage.setItem("deptName",e.data.deptName),sessionStorage.setItem("developLeader",e.data.deptCode)}else layer.msg(e.data)},error:function(e){}})}function detailsData(){var e={query:{accessToken:accessToken,id:deatailId,projectName_LIKE:parent.projectName}};loadingtip.show(),xhsdk.ajax({type:"post",url:solution+"/projectinfo/find",contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:function(e){200==e.code?initdata(e.data):layer.msg("请求出现错误!!")},error:function(e){layer.msg("请求出现错误!!")}})}function initdata(e){loadingtip.hide(),$("#project_Name").val(e.projectName),$("#project_code").val(e.projectCode),$("#buildUnit").val(e.buildUnitName),$("#project_Background").text(e.projectDesc),$(".file-name").text(e.remark),$(".fileUrl").text(e.projectFile),$(".download-file").attr("href",e.projectFile),$("#staffvalue").val(e.buildUnitLeaderName),$("#staffvalue").attr("data-userId",e.buildUnitLeader),$("#buildUnit").attr("data-code",e.buildUnit)}function uploadingFiles(){var e=$("#project_Enclosure")[0].files[0],a=new FormData;a.append("fileList",e),a.append("userId",$("#staffvalue").data("userId")),a.append("userName",$("#staffvalue").val()),a.append("terminalType",1),a.append("organization",$("#buildUnit").val()),a.append("organizationId",$("#buildUnit").data("code")),loadingtip.show(),xhsdk.ajax({url:fileService_Url+"/s3/file/uploadByIStream",type:"POST",contentType:!1,processData:!1,mimeType:"multipart/form-data",data:a,success:function(e){200==(e=JSON.parse(e)).code?(loadingtip.hide(),e.data&&$(".fileUrl").text(e.data[0].fileUrl)):(layer.msg("附件上传失败，请重新上传！"),loadingtip.hide())},error:function(){loadingtip.hide(),layer.msg("请求出现错误!!")}})}$(".ProgrammeList li").hover(function(){$(this).addClass("layui-this").siblings().removeClass("layui-this")}),upload.render({elem:"#project_Enclosure",auto:!1,accept:"file",choose:function(e){e.preview(function(e,a,t){$(".file-name").text(a.name),uploadingFiles()})}}),$(".submitbutton").click(function(){$(".layui-col-md10 .layui-form-item").each(function(e,a){if($(".verify-value").eq(e).val().length<1){if(3==e)return;$(".ProgrammeList li .box-veirfy").eq(e).empty(),$(".ProgrammeList li .box-veirfy").eq(e).append('<span class="font-red"><i class="iconfont icon-bitian" style="margin:-5px"></i><span>必填</span></span>')}else $(".ProgrammeList li .box-veirfy").eq(e).empty(),$(".ProgrammeList li .box-veirfy").eq(e).append('<span class="correct"><i class="layui-icon-ok layui-icon" style="margin:-5px;font-size: 18px">&#xe605;</i></span>')})});var saveFlag=!1;function projectinfo(){if(0==saveFlag){saveFlag=!0;var e=$("#project_Name").val().length,a=$("#project_code").val().length;if(30<e)layer.msg("项目名称字数过多");else if(30<a)layer.msg("项目编码字数过多");else{var t={};2==tag&&(t.id=deatailId),t.accessToken=accessToken,t.projectName=$("#project_Name").val(),t.projectCode=$("#project_code").val(),t.buildUnitName=$("#buildUnit").val(),t.buildUnitLeaderName=$("#staffvalue").val(),t.projectDesc=$("#project_Background").val(),t.projectFile=$(".fileUrl").text(),t.createBy=$("#staffvalue").val(),t.updateBy=$("#staffvalue").val(),t.buildUnitLeader=$("#staffvalue").data("userid"),t.buildUnit=$("#buildUnit").data("code"),t.remark=$(".file-name").text(),loadingtip.show(),xhsdk.ajax({type:"POST",url:solution+"/projectinfo/save",contentType:"application/json",datatype:"json",timeout:1e3,data:JSON.stringify(t),success:function(e){200==e.code?(loadingtip.hide(),layer.msg("完成!",{icon:1,time:600},function(){parent.location.reload()})):(saveFlag=!1,loadingtip.hide(),layer.msg(e.data))},error:function(e,a){loadingtip.hide(),layer.msg("失败！")}})}}}form.verify({project_Name:function(e){return e.length<1?"请输入项目名称":30<e.length?"字数过长,请重新输入!":void 0},project_code:function(e){return e.length<1?"请输入项目编码":30<e.length?"字数过长,请重新输入!":void 0},project_Background:function(e){if(e.length<1)return"请输入项目背景"}});var applyflag=0;function projectapply(){var e={accessToken:accessToken,projectName:$("#project_Name").val(),projectCode:$("#project_code").val(),buildUnitName:$("#buildUnit").val(),buildUnitLeaderName:$("#staffvalue").val(),projectDesc:$("#project_Background").val(),projectFile:$(".fileUrl").text(),createBy:$("#staffvalue").val(),updateBy:$("#staffvalue").val(),buildUnitLeader:$("#staffvalue").data("userid"),buildUnit:$("#buildUnit").data("code"),remark:$(".file-name").text(),id:deatailId};loadingtip.show(),xhsdk.ajax({type:"POST",url:solution+"/projectinfo/save",contentType:"application/json",datatype:"json",data:JSON.stringify(e),success:function(e){if(200==e.code){loadingtip.hide();var a=e.data;if(null==a)return layer.msg("提交申请失败,请重试...."),void(applyflag=0);itemapplyID(a)}else layer.msg(e.data),applyflag=0,loadingtip.hide()},error:function(e,a){loadingtip.hide(),layer.msg("失败！")}})}function itemapplyID(e){var a={accessToken:accessToken,id:e,applyBy:$("#staffvalue").val()};loadingtip.show(),xhsdk.ajax({type:"POST",url:solution+"/projectinfo/apply",contentType:"application/json",datatype:"json",data:JSON.stringify(a),success:function(e){200==e.code?(loadingtip.hide(),layer.msg("完成!",{icon:1,time:600},function(){parent.location.reload()})):(loadingtip.hide(),layer.msg(e.data))},error:function(){loadingtip.hide(),layer.msg("请求失败！")}})}form.on("submit(sumbitApply)",function(e){return 0==applyflag&&(projectapply(),applyflag=1),!1});