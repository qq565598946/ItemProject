"use strict";var indexloading,form=layui.form,laypage=layui.laypage;function GetQueryString(t){var a=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),e=window.location.search.substr(1).match(a);return null!=e?unescape(e[2]):null}var accessToken=GetQueryString("TokenCode"),xhsdk=new Xhsdk(appID,appSecretKey);xhsdk.setGetaWayUrl(GetaWay_url),xhsdk.setToken(accessToken),xhsdk.setReqType("app"),xhsdk.setUserInfo(null);var deatailId=GetQueryString("deatailId"),statusID=GetQueryString("status");0==statusID||3==statusID||1==statusID?$("#addsolutionBtn").empty():$("#addsolutionBtn").html('<button class="layui-btn layui-btn-normal  layui-btn-sm" id="add-item" onclick="solutionData()">添加</button>'),$(function(){detailsData(),GetprojectID()});var AddprojectID=null,versionCon=null,upgrade=null;function GetprojectID(){var t={accessToken:accessToken,projectId:deatailId};xhsdk.ajax({type:"post",url:solution+"/solutioninfo/getDevelopLeader",contentType:"application/json",dataType:"json",data:JSON.stringify(t),success:function(t){if(200==t.code){if(upgrade=t.data.version,2==statusID&&1<parseInt(upgrade)){var a='<button class="layui-btn layui-btn-normal  layui-btn-sm" id="add-item" onclick="solutionData(this,3,\''+t.data.oldSolutioninfoId+"')\">升级</button>";$("#addsolutionBtn").html(a)}AddprojectID=t.data.id,versionCon=t.data.version+".0",sessionStorage.setItem("userName",t.data.userName),sessionStorage.setItem("userId",t.data.userId),sessionStorage.setItem("deptCode",t.data.deptCode)}else layer.msg(t.data)},error:function(t){layer.msg("请求出现错误!!")}})}function detailsData(){var t={accessToken:accessToken,query:{id:deatailId,projectName_LIKE:""}},a=layer.load(2,{shade:!1});xhsdk.ajax({type:"post",url:solution+"/projectinfo/find",contentType:"application/json",dataType:"json",data:JSON.stringify(t),success:function(t){200==t.code?(layer.close(a),initdata(t.data)):(layer.close(a),layer.msg("请求出现错误!!"))},error:function(t){layer.close(a),layer.msg("请求出现错误!!")}})}function initdata(t){$(".projectName").text(t.projectName),$(".projectcode").text(t.projectCode),$(".projectBackground").text(t.projectDesc),$(".item_name").text(t.remark),$(".download-file").attr("href",t.projectFile),$(".projectResponsible").text(t.buildUnitLeaderName),$(".buildUnit").text(t.buildUnitName)}var btnclass=$(".layui-tab-item button").hasClass("layui-btn-sm");function initPceed(t,i){var a={accessToken:accessToken,query:{projectId:deatailId},page:{current:t,size:i}};xhsdk.ajax({type:"post",url:solution+"/solutioninfo/list",contentType:"application/json",dataType:"json",data:JSON.stringify(a),success:function(t){if(!(t.data.records.length<1))if(200==t.code){var a=t.data.records,e=t.data.total,o=t.data.current;e<=10?$("#loading-button").hide():$("#loading-button").show(),proceedProject(a),laypage.render({elem:"loading-button",count:Math.ceil(e),limit:i,groups:e,layout:["prev","page","next"],curr:o,jump:function(t,a){a||initPceed(t.curr,i)}})}else layer.msg("请求出现错误!!")},error:function(t){layer.msg("请求出现错误!!")}})}function proceedProject(t){$(".loading-project-box").empty(),$("#loading_box").show();for(var a=0;a<t.length;a++){var e=t[a].auditStatus,o=t[a].solutionStage,i="",n="",s=null;switch(e){case 0:n="草稿",s='<a href="javascript:void(0)" data-moduleId="'+t[a].id+'" data-id="'+t[a].id+'"title="编辑" onclick="solutionData(this,2)"><i class="iconfont icon-bianji1"></i></a><a href="javascript:void(0)" data-moduleid="'+t[a].id+'" title="删除" onclick="DelsolutionData(this)"><i class="iconfont icon-icon"></i></a>';break;case 1:n='<span style="color: #cc940b;">审核中</span>',s='<a href="javascript:void(0)" data-id="'+t[a].id+'" title="详情" data-auditstatus="'+t[a].auditStatus+'" onclick="solutiondeatail(this)" ><i class="iconfont icon-icon-"></i></a>';break;case 2:n='<span style="color:#15ca15">通过</span>',s='<a href="javascript:void(0)" data-id="'+t[a].id+'" title="详情" data-auditstatus="'+t[a].auditStatus+'" onclick="solutiondeatail(this)" ><i class="iconfont icon-icon-"></i></a>';break;case 3:n='<span style="color:#CCCCCC">驳回</span>',s='<a href="javascript:void(0)" data-id="'+t[a].id+'" title="编辑" onclick="solutionData(this,2)"><i class="iconfont icon-bianji1"></i></a><a href="javascript:void(0)" data-moduleid="'+t[a].id+'" title="删除" onclick="DelsolutionData(this)"><i class="iconfont icon-icon"></i></a>';break;case 4:n="下线";break;case 5:n="删除";break;default:n="-"}switch(o){case 0:i="无";break;case 1:i="建设单位科技管理责任人";break;case 2:i="建设单位科技管理负责人";break;case 5:i="科信委立项审核";break;case 3:i="平台审核组";break;case 4:i="市局科信委";break;default:i="-"}var d="<tr><td>"+t[a].solutionName+"</td><td>"+t[a].solutionVersion+'</td><td class="plan-box" data-status="'+t[a].auditStatus+'">'+n+"</td><td>"+t[a].developOrgan+"</td><td>"+t[a].developLeaderName+"</td><td>"+i+'</td><td  class="destail-button"><div class="edit-box">'+s+"</div></td></tr>";$(d).appendTo(".loading-project-box")}}function DelsolutionData(a){layer.confirm("确认删除吗？",{btn:["确认","取消"]},function(){var t={id:$(a).data("moduleid")};indexloading=layer.load(2,{shade:!1}),xhsdk.ajax({type:"post",url:solution+"/solutioninfo/remove",contentType:"application/json",dataType:"json",data:JSON.stringify(t),success:function(t){1==t.data?(layer.close(indexloading),layer.msg("删除完成!",{icon:1,time:600},function(){initPceed(),layer.close()})):(layer.close(indexloading),layer.msg(t.data))},error:function(t){layer.close(indexloading),layer.msg("请求出现错误!!")}})},function(){layer.close(indexloading),layer.msg("已取消")})}function solutionData(t,a,e){var o=$(t).data("moduleid"),i=$(t).data("id");3!=a?layer.open({type:2,anim:5,maxmin:!0,title:"添加项目实施",shadeClose:!1,area:["100%","100%"],content:"../pm_setDoc/pm_setDoc.html?tag=1&addprojectID="+AddprojectID+"&projectid="+deatailId+"&moduleId="+o+"&itemID="+i+"&flagid="+a+"&TokenCode="+accessToken+"&version="+versionCon,end:function(){initPceed(),GetprojectID()}}):layer.open({type:2,anim:5,maxmin:!0,title:"项目实施升级",shadeClose:!1,area:["100%","100%"],content:"../pm_setDoc/pm_Change/project_Change.html?tag=1&itemID="+e+"&TokenCode="+accessToken+"&auditstatus=2&flagid=2&projectid=null&addprojectID=null&oldflag=4",end:function(){initPceed(),GetprojectID()}})}function solutiondeatail(t){var a=$(t).data("id"),e=$(t).data("auditstatus");layer.open({type:2,title:"实施方案详情",shadeClose:!0,maxmin:!0,area:["100%","100%"],content:"../pm_setDoc_deastail/pm_setDoc_deastail.html?tag=1&itemID="+a+"&TokenCode="+accessToken+"&auditstatus="+e+"&projectid="+deatailId+"&addprojectID="+AddprojectID})}function add0(t){return t<10?"0"+t:t}function formatTime(t){var a=new Date(t),e=a.getFullYear(),o=a.getMonth()+1,i=a.getDate(),n=a.getHours(),s=a.getMinutes(),d=a.getSeconds();return e+"-"+add0(o)+"-"+add0(i)+" "+add0(n)+":"+add0(s)+":"+add0(d)}1==btnclass&&initPceed(1,5),$(".ProgrammeList").on("click","li",function(){$(this).addClass("layui-this").siblings().removeClass("layui-this"),0<=$(this).attr("class").indexOf("now_Programme")?($(".nowProgramme").show(),$(".historyProgramme").hide()):($(".nowProgramme").hide(),$(".historyProgramme").show())});