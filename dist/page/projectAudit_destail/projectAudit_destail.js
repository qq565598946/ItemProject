"use strict";var formSelects=layui.formSelects;function GetQueryString(i){var n=new RegExp("(^|&)"+i+"=([^&]*)(&|$)"),t=window.location.search.substr(1).match(n);return null!=t?unescape(t[2]):null}var accessToken=GetQueryString("TokenCode"),xhsdk=new Xhsdk(appID,appSecretKey);xhsdk.setGetaWayUrl(GetaWay_url),xhsdk.setToken(accessToken),xhsdk.setReqType("app"),xhsdk.setUserInfo(null);var form=layui.form,moduleId=GetQueryString("moduleid"),projectID=GetQueryString("projectID"),status=GetQueryString("status"),solutionstage=GetQueryString("solutionstage"),loadingTip=$(".loading-box1");switch($(function(){showAuditBoxCon()}),status){case"1":auditbtn();break;case"2":case"3":$(".box-right-edit").hide();break;default:$(".box-right-edit").hide()}function auditbtn(){$(".box-audit").html('<div class="box-audit"> \n\n                        <button class="layui-btn layui-btn-danger layui-btn-sm" style="width:100px" id="disagree" onclick="showauditbox()">不同意</button>\n                        \n                        <button onclick="isagredd(2)" class="layui-btn layui-btn-sm" id="agressd" style="width:100px;background-color:#295596;">同意</button>\n                        \n                        </div>')}var moduleAuditID="",applicationdesignList="",microserviceList="",saveDeployrun="",applicationdesignAuditList="",microserviceAuditList="";function edit(t,a){init(!1,a),moduleId1=$(a).attr("data-audit"),loadingTip.show(),xhsdk.ajax({type:"POST",url:solution+"/solutionAudit/getSolutionAudit",contentType:"application/json",dataType:"json",data:'{"id":"'+moduleId+'","moduleId":"'+moduleId1+'"}',success:function(i){if(200==i.code){for(var n=0;n<i.data.length;n++)0==i.data[n].effect&&(moduleAuditID=i.data[n].id);switch(loadingTip.hide(),t){case 1:auditoverview("#overview",".overview",moduleAuditID,0,a);break;case 2:auditoverview("#pj-demandAnalysis",".demanalysisList",moduleAuditID,1,a);break;case 3:auditoverview("#pj-design",".saveArchidesign",moduleAuditID,2,a);break;case 4:auditnormalize();break;case 5:auditoverview("#pj-application",".applicationdesignList",moduleAuditID,4,a);break;case 6:auditoverview("#pj-service",".microserviceList",moduleAuditID,5,a);break;case 7:auditoverview("#pj-deploy",".deployrunList",moduleAuditID,6,a);break;case 8:auditoverview("#pj-solution",".risksolutionList",moduleAuditID,7,a)}}else loadingTip.hide(),layer.msg("数据异常！")},error:function(i){loadingTip.hide(),layer.msg("请求出现错误!!")}})}$(function(){init(!0)}),$(".ProgrammeList").on("click","li",function(){$(this).addClass("layui-this").siblings().removeClass("layui-this")});var overcont=null,auditid=null;function auditoverview(n,i,t,a,e){auditid=$(e).data("audit"),overcont=$(i).text();$(".popUpbox").html('  <div class="editContent">\n                        <p><span>审批处理</span></p>\n                        <div class="box-content-audit layui-form">\n                            <div class="layui-form-item layui-form-text">\n                                <label class="layui-form-label">意见说明 :</label>\n                                <div class="layui-input-block">\n                                    <textarea placeholder="请输入内容" class="layui-textarea opinion" id="textOpinion" style="height: 205px;"></textarea>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="btn-group">\n                            <button class="layui-btn layui-btn-primary cancelEditor" onclick="closefn()">取消</button>\n                            <button class="layui-btn layui-btn-primary getDocData">确定</button>\n                        </div>\n                    </div>'),$(".popUpbox").show(),$(".getDocData").click(function(){var i=$("#textOpinion").val().length;sumbitoverview(n,t,a,i,e)})}function sumbitoverview(i,n,t,a,e){if(0!==a){var o={accessToken:accessToken,id:n,solutionStage:solutionstage,applyBy:$(".applyBy").val(),solutionModule:overcont,moduleId:auditid,auditBy:$("#applyName").val(),opinion:$(".opinion").val(),solutionId:moduleId};loadingTip.show(),xhsdk.ajax({type:"POST",url:solution+"/solutionAudit/moduleAudit",contentType:"application/json",dataType:"json",data:JSON.stringify(o),success:function(i){200==i.code?(loadingTip.hide(),$(e).siblings(".audit-cont").html('<span class="audit-txt">意见:'+$(".opinion").val()+"</span>"),$(".opinion-box ul li:eq("+t+") span").text($(".opinion").val()),$(".opinion-box ul li:eq("+t+")").show(),$(".popUpbox").hide(),$(".popUpbox").empty(),auditid=overcont=null):(loadingTip.hide(),layer.msg("数据异常！"))},error:function(i){loadingTip.hide(),layer.msg("请求出现错误!!")}})}else layer.msg("意见不能为空！")}var indexloading,navJson={accessToken:accessToken,solutionId:moduleId};function init(v){loadingTip.show(),xhsdk.ajax({type:"POST",url:solution+"/projectManagement/list",contentType:"application/json",dataType:"json",data:JSON.stringify(navJson),success:function(i){if(200==i.code){loadingTip.hide();var n=i.data.solutioninfoList,t=i.data.overviewList,a=i.data.demanalysisList,e=i.data.archidesignList;applicationdesignList=i.data.applicationdesignList,microserviceList=i.data.microserviceList,saveDeployrun=i.data.deployrunList;var o=i.data.risksolutionList,s=i.data.overviewaAuditList,d=i.data.demanalysisAuditList,l=i.data.archidesignAuditList;applicationdesignAuditList=i.data.applicationdesignAuditList,microserviceAuditList=i.data.microserviceAuditList;var p=i.data.risksolutionAuditList;if(v){if(basicinfo(n),projectDetail(t),DetailDemanalysis(a),DetailArchidesign(e),Detailmicroservice(microserviceList),Detailapplicationdesign(applicationdesignList),Detaildeployrun(o),0!==s.length&&(auditOpinion(s,"#overview",0),$("#overview").find(".audit-i-box").show()),0!==d.length&&(auditOpinion(d,"#pj-demandAnalysis",0),$("#pj-demandAnalysis").find(".audit-i-box").show()),0!==l.length&&(auditOpinion(l,"#pj-design",0),$("#pj-design").find(".audit-i-box").show()),0!==p.length&&(auditOpinion(p,"#pj-solution",0),$("#pj-solution").find(".audit-i-box").show()),0!==microserviceAuditList.length)for(var u=0;u<microserviceList.length;u++)for(var c="",r=0;r<microserviceAuditList.length;r++)microserviceAuditList[r].moduleId==microserviceList[u].id&&(c="<li>"+(r+1)+"、"+microserviceAuditList[r].opinion+"</li> <div>审核人 : <span>"+microserviceAuditList[r].auditName+"</span></div>\n                            <div>审核时间 : <span>"+microserviceAuditList[r].auditTime+"</span></div>",$("#pj-service").find(".OpinionList").eq(u).append(c),$("#pj-service").find(".audit-i-box").eq(u).show());if(0!==applicationdesignAuditList.length)for(u=0;u<applicationdesignList.length;u++)for(c="",r=0;r<applicationdesignAuditList.length;r++)applicationdesignAuditList[r].moduleId==applicationdesignList[u].id&&(c="<li>"+(r+1)+"、"+applicationdesignAuditList[r].opinion+"</li> <div>审核人 : <span>"+applicationdesignAuditList[r].auditName+"</span></div>\n                            <div>审核时间 : <span>"+applicationdesignAuditList[r].auditTime+"</span></div>",$("#pj-application").find(".OpinionList").eq(u).append(c),$("#pj-application").find(".audit-i-box").eq(u).show())}if(0!==s.length&&($("#overview").find(".audit-cont").html(""),$("#overview").find(".audit-cont").append(s[0].opinion),auditOpinion(s)),0!==d.length&&($("#pj-demandAnalysis").find(".audit-cont").html(""),$("#pj-demandAnalysis").find(".audit-cont").append(d[0].opinion),auditOpinion(d)),0!==l.length&&($("#pj-design").find(".audit-cont").html(""),$("#pj-design").find(".audit-cont").append(l[0].opinion)),0!==p.length&&($("#pj-solution").find(".audit-cont").html(""),$("#pj-solution").find(".audit-cont").append(p[0].opinion)),0!==applicationdesignAuditList.length){2!=status&&3!=status||$(".box-right-edit").hide();for(r=0;r<applicationdesignAuditList.length;r++)applicationdesignAuditList[r].moduleId==applicationdesignList[r].id&&($("#pj-application .audit-cont").eq(r).html(""),$("#pj-application .audit-cont").eq(r).append(applicationdesignAuditList[r].opinion))}if(0!==microserviceAuditList.length){2!=status&&3!=status||$(".box-right-edit").hide();for(r=0;r<microserviceAuditList.length;r++)microserviceAuditList[r].moduleId==microserviceList[r].id&&($("#pj-service .audit-cont").eq(r).html(""),$("#pj-service .audit-cont").eq(r).append(microserviceAuditList[r].opinion))}}else layer.msg("请求出现错误!!")},error:function(i){layer.msg("请求出现错误!!")}})}function showAuditBoxCon(){$(".audit-i-box").hover(function(){$(this).parent().parent().find(".audit_opinion").show()},function(){$(this).parent().parent().find(".audit_opinion").hide()})}function showserviceApp(){$(".service-box .audit-i-box").hover(function(){$(this).parents().find(".audit_opinion").show()},function(){$(this).parents().find(".audit_opinion").hide()})}function auditOpinion(i,n,t){$(n).find(".OpinionList").html("");for(var a="",e=0;e<i.length;e++)a+="<li>"+(e+1)+"、审核意见: "+(e+1)+" : "+i[e].opinion+"</li>\n                            <div>审核人 : <span>"+i[e].auditName+"</span></div>\n                            <div>审核时间 : <span>"+i[e].auditTime+"</span></div>";$(n).find(".OpinionList").eq(t).append(a)}function basicinfo(i){for(var n=0;n<i.length;n++)$(".project_Name").val(i[n].solutionName),$(".developOrgan ").val(i[n].makeUnit),$(".solutionVersion ").val(i[n].solutionVersion),$(".staffvalue ").val(i[n].developLeaderName),$(".kfdevelopOrgan").val(i[n].developOrgan),$(".applyBy").val(i[n].applyBy),$(".applyName").val(i[n].applyName),$("#pj-staffvalue").find(".staffvalue-box p").text(i[n].developerName)}function projectDetail(i){for(var n=0;n<i.length;n++)$("#overview").find(".box-right-edit").attr("data-audit",i[n].id),$("#pj-background").children("p").text(i[n].projectBackground),$("#systemCurrent").children("p").text(i[n].systemCurrent),$("#buildGoal").children("p").text(i[n].buildGoal),$("#buildContent").children("p").text(i[n].buildContent);$("#overview").append('<div class="audit_opinion"><ul class="OpinionList"></ul></div>')}function DetailDemanalysis(i){for(var n=0;n<i.length;n++)$("#pj-demandAnalysis").find(".box-right-edit").attr("data-audit",i[n].id),$("#functionalRoleAnalysis").children("p").text(i[n].functionalRoleanalysis),$("#businessRequirements").children("p").text(i[n].businessRequirements),$("#dataIntegration").children("p").text(i[n].dataIntegration);$("#pj-demandAnalysis").append('<div class="audit_opinion"><ul class="OpinionList"></ul></div>')}function DetailArchidesign(i){for(var n=0;n<i.length;n++){$("#pj-design").find(".box-right-edit").attr("data-audit",i[n].id);var t='\n                           <div class="item-box">\n                                <div class="item-destail">\n                                    <span>总体架构</span>\n                                        <p>'+i[n].frameworkDesign+'</p>\n                                </div>\n                            </div>  \n                    \n                     <div class="item-box">\n                                <div class="item-destail">\n                                    <span>网络拓扑图</span>\n                                    <img src="'+i[n].topologicalPic+'" alt="">\n                                </div>\n                            </div>  \n                   \n                     <div class="item-box">\n                                <div class="item-destail">\n                                    <span>系统建设原则及路线</span>\n                                        <p>'+i[n].principlesRoutes+"</p>\n                                </div>\n                            </div>  \n                    \n                    \n                    ";$(t).appendTo(".design-box")}$("#pj-design").append('<div class="audit_opinion"><ul class="OpinionList"> </ul></div>')}function GetserviceData(a,e,o,s,d){var l=[];xhsdk.ajax({url:solution+"/microservice/getServerList",type:"POST",contentType:"application/json",dataType:"json",data:'{"accessToken":"'+accessToken+'"}',success:function(i){if(200==i.code){for(var n=i.data.resulList,t=0;t<n.length;t++)l.push({name:n[t].serverName,value:n[t].serverinfoID});if(formSelects.data(a,"local",{arr:l}),formSelects.data(e,"local",{arr:l}),1==d)return;formSelects.value(a,o,!0),formSelects.value(e,s,!0)}else layer.msg("网络错误！")},error:function(i){layer.msg("数据请求错误!")}})}function Detailmicroservice(i){for(var n=0;n<i.length;n++){var t=i[n].generalService.split(","),a=i[n].basicService.split(","),e='\n                <div class="app-list layui-form">\n                    <div class="item-box">\n                        <div class="item-destail">\n\t                              <span>服务名称</span>\n\t                              <span class="audit-cont"></span>\n\t                               <i class="iconfont icon-bitian audit-i-box"></i>\n\t                              <i class="iconfont icon-bianji box-right-edit" data-isadd="true" onclick="edit(6,this)" data-audit="'+i[n].id+'"></i>\n                              \n                            <p>'+i[n].serviceName+'</p>\n                        </div>\n                    </div>\n                    <div class="item-box">\n                        <div class="item-destail">\n                            <span>服务类型</span>\n                            <div style="width: 160px;margin: 10px 0px;">\n                                    <select name="quiz" class="serviceType'+n+'" disabled>\n                                        <option value="1">基础技术服务</option>\n                                        <option value="2">通用业务服务</option>\n                                        <option value="3">应用服务</option>\n                                    </select>\n                                </div>\n                          \n                        </div>\n                    </div>\n                    <div class="item-box">\n                        <div class="item-destail">\n                            <span>服务设计</span>\n                                <p>'+i[n].serviceDesign+'</p>\n                        </div>\n                    </div>\n                      <div class="item-box">\n                        <div class="item-destail">\n                            <span>通用业务服务</span>\n                                \x3c!--<p>'+i[n].generalService+'</p>--\x3e\n                                 <div class="box-select-business layui-input-inline" style="margin:20px 0px; width: 100%">\n                                <select xm-select="business_des'+n+'" disabled>\n                                               \n                                </select>\n                            </div>\n                        </div>\n                    </div>\n                     <div class="item-box">\n                        <div class="item-destail">\n                            <span>基础技术服务</span>\n                                \x3c!--<p>'+i[n].basicService+'</p>--\x3e\n                                  <div class="box-select-technical layui-input-inline" style="margin:20px 0px;width: 100%">\n                                <select xm-select="technical_des'+n+'" disabled>\n                                                 \n                                </select>\n                            </div>\n                        </div>\n                    </div>\n                    \n                       <div class="item-box">\n                        \n                            <div class="item-destail"><span>部署环境和运行资源</span>\n                             <div class="hj-box"><strong>部署环境:</strong><strong>'+i[n].deploymentEnvironment+'</strong></div>\n                            <div class="hj-box"><strong>运行资源:</strong><strong>'+i[n].runResource+"</strong></div>\n                            </div>\n\n                        </div>\n                </div>\n";$(e).appendTo(".service-box"),$(".serviceType"+n+" option[value = "+i[n].serviceType+"]").attr("selected","selected"),GetserviceData("business_des"+n,"technical_des"+n,a,t,3),form.render()}$("#pj-service").find(".app-list").append('<div class="audit_opinion"><ul class="OpinionList"></ul></div>'),$(".service-box .audit-i-box").hover(function(){$(this).parent().parent().parent().parent().find(".audit_opinion").show()},function(){$(this).parents().parent().parent().parent().find(".audit_opinion").hide()})}function Detailapplicationdesign(i){for(var n=0;n<i.length;n++){var t=i[n].frontIntegration.split(","),a=' <div class="app-list">\n                        <div class="item-box">\n                                <div class="item-destail">\n                                    <span>应用名称</span>\n                                      <span class="audit-cont"></span>\n                                        <i class="iconfont icon-bitian audit-i-box"></i>\n                                      <i class="iconfont icon-bianji box-right-edit" data-isadd="true" onclick="edit(5,this)" data-audit="'+i[n].id+'"></i>\n                                  \n                                        <p>'+i[n].applicationName+'</p>\n                                    </div>\n                                    \n                                    </div>\n\t                        <div class="item-box">\n\t                            <div class="item-destail">\n\t                                   <span>项目概述</span>\n                                     \n\t                                <p>'+i[n].applicationOverview+'</p>\n\t                            </div>\n\t                        </div>\n\t                         <div class="item-box">\n\t                            <div class="item-destail">\n\t                                    <span>应用UI/UE规划</span>\n\t                                <p>'+i[n].applicationPlanning+'</p>\n\t                            </div>\n\t                        </div>\n\t                         <div class="item-box">\n\t                            <div class="item-destail">\n\t                                    <span>应用功能逻辑</span>\n\t                                <p>'+i[n].applyLogicdiagram+'</p>\n\t                            </div>\n\t                        </div>\n\t                        <div class="item-box">\n\t                                \n\t                            <div class="item-destail">\n\t                                    <span>前端服务化能力集成</span>\n\t                                       <div class="" style="width: 100%;margin: 20px 0px">\n                                         \n                                            <select xm-select="select-id'+n+'" disabled="disabled" class="frontIntegration'+n+'">\n                                                <option value="1">人脸识别服务</option>\n                                                <option value="2">车牌识别服务</option>\n                                                <option value="3">证件识别服务</option>\n                                                <option value="4">扫一扫服务</option>\n                                                <option value="5">证件识别服务</option>\n                                                <option value="6">选择文件</option>\n                                                <option value="7">电子签名</option>\n                                                <option value="8">获取定位</option>\n                                                <option value="9">获取手机状态（NFC、蓝牙、GPS、WIFI等）</option>\n                                                <option value="10">设置手机状态（NFC、蓝牙、GPS、WIFI等）</option>\n                                                <option value="11">获取海拔</option>\n                                                <option value="12">图片压缩</option>\n                                            </select>\n                                        </div>\n\t                                \x3c!--<p>'+i[n].frontIntegration+"</p>--\x3e\n\t                            </div>\n\t                        </div>\n                        </div>";$(a).appendTo(".box-app"),formSelects.render("select-id"+n),formSelects.value("select-id"+n,t,!0)}$("#pj-application .app-list").append('<div class="audit_opinion"><ul class="OpinionList"></ul></div>'),$("#pj-application .audit-i-box").hover(function(){$(this).parent().parent().parent().parent().find(".audit_opinion").show()},function(){$(this).parent().parent().parent().parent().find(".audit_opinion").hide()})}function Detailarchidesign(i){for(var n=0;n<i.length;n++){var t='\n                    <div class="item-box app-list">\n                        <div class="item-destail">\n                            <h3>\n                              <span>部署环境</span>\n                              <span class="audit-cont"></span>\n                              <i class="iconfont icon-bianji box-right-edit" data-isadd="true" onclick="edit(7,this)" data-audit="'+i[n].id+'"></i>\n                            </h3>\n                            <p>'+i[n].deploymentEnvironment+'</p>\n                        </div>\n                         <div class="item-destail">\n                            <span>运行资源(cpu/内存/磁盘): </span>\n                            <p>'+i[n].runResource+"</p>\n                        </div>\n                    </div>\n";$(t).appendTo(".deploy-box")}}function Detaildeployrun(i){for(var n=0;n<i.length;n++){$("#pj-solution").find(".box-right-edit").attr("data-audit",i[n].id);var t='\n                 <div class="item-box">\n                        <div class="item-destail">\n                            <span>风险解决方案</span>\n                                <p>'+i[n].riskSolution+"</p>\n                        </div>\n                    </div>             \n    ";$(t).appendTo("#pj-solution .solution-box")}$("#pj-solution").append('<div class="audit_opinion"><ul class="OpinionList"></ul></div>')}function returnTop(){$(window).scroll(function(){100<$(window).scrollTop()?$(".returnTop").fadeIn(1e3):$(".returnTop").fadeOut(1e3)}),$(".returnTop").click(function(){return $("html").scrollTop()?$("html").animate({scrollTop:0},500):$("body").animate({scrollTop:0},500),!1})}var auditURL=null;function isagredd(n){switch(solutionstage){case"1":auditURL=solution+"/solutionAudit/audit";break;case"2":auditURL=solution+"/solutionAudit/audit1";break;case"5":auditURL=solution+"/solutionAudit/audit4";break;case"3":auditURL=solution+"/solutionAudit/audit2";break;case"4":auditURL=solution+"/solutionAudit/audit3"}var t=null,i=null;i=2==n?(t=2,"同意"):(t=3,"不同意"),layer.confirm(i,{title:"审核",btn:["确认","取消"]},function(){indexloading=layer.load(2,{shade:!1});var i={accessToken:accessToken,id:moduleId,solutionStage:solutionstage,auditStatus:t,applyBy:$(".applyBy").val(),applyName:$(".applyName").val(),moduleId:moduleId};xhsdk.ajax({url:auditURL,type:"POST",contentType:"application/json",data:JSON.stringify(i),success:function(i){200==i.code?(layer.close(indexloading),2==n?(layer.msg("审核通过"),setTimeout(function(){parent.init(1,10,2);var i=parent.layer.getFrameIndex(window.name);parent.layer.close(i)},500)):(layer.msg("审核不通过"),setTimeout(function(){init(1,10,2);var i=parent.layer.getFrameIndex(window.name);parent.layer.close(i)},500))):(layer.msg(i.data),layer.close(indexloading))},error:function(i){layer.close(indexloading),layer.msg("网络错误")}})},function(){layer.msg("已取消")})}function closefn(){$(".popUpbox").hide()}function showauditbox(){switch(solutionstage){case"1":auditURL=solution+"/solutionAudit/audit";break;case"2":auditURL=solution+"/solutionAudit/audit1";break;case"5":auditURL=solution+"/solutionAudit/audit4";break;case"3":auditURL=solution+"/solutionAudit/audit2";break;case"4":auditURL=solution+"/solutionAudit/audit3"}$(".audit-box-tip").show()}function del(i){$(i).hide()}$(".btn-group").on("click",".getDocData",function(){if($("#opinion-val").val().length<1)layer.msg("请输入审核意见");else{var i={accessToken:accessToken,id:moduleId,auditStatus:"3",solutionStage:solutionstage,opinion:$("#opinion-val").val(),applyBy:$(".applyBy").val(),applyName:$(".applyName").val()};loadingTip.show(),xhsdk.ajax({url:auditURL,type:"POST",contentType:"application/json",data:JSON.stringify(i),success:function(i){200==i.code?(loadingTip.hide(),layer.msg("审核成功"),setTimeout(function(){parent.init();var i=parent.layer.getFrameIndex(window.name);parent.layer.close(i)},500)):(layer.msg(i.data),loadingTip.hide())},error:function(i){loadingTip.hide()}})}}),$(".opinion-box ul li .del-i").click(function(){$(this).parent().hide()}),$(".btn-group").on("click",".cancelEditor",function(){$(".audit-box-tip").hide()});